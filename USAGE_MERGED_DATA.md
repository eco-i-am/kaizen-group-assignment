# Using Merged User Grouping Preference Data for Group Assignment

This guide explains how to use the updated `group_assignment_to_excel.py` script with merged user grouping preference data from the Streamlit app.

## Overview

The group assignment script has been updated to work with the merged Excel files generated by the Streamlit app (`app_simple.py`). These files contain both user data and grouping preferences in a single Excel file with multiple sheets.

## File Structure

The merged Excel file typically contains these sheets:
- **Merged Data**: Main dataset with all user and preference information
- **Users Data**: Original user data
- **Grouping Preferences**: Original grouping preferences
- **Summary**: Summary statistics

## How to Use

### Step 1: Generate Merged Data

1. Run the Streamlit app:
   ```bash
   streamlit run app_simple.py
   ```

2. Navigate to the "API Data" page
3. Fetch both users data and grouping preferences data
4. Click "Merge and Download Excel" to generate the merged file

### Step 2: Update Input File

Edit `group_assignment_to_excel.py` and update the `INPUT_FILE` variable:

```python
# File paths - Updated to use merged Excel file
INPUT_FILE = 'your_merged_file.xlsx'  # Change this to your merged file
OUTPUT_FILE = 'grouped_participants.xlsx'
```

### Step 3: Run Group Assignment

```bash
python group_assignment_to_excel.py
```

## Automatic Column Detection

The script automatically detects column names using these mappings:

| Expected Field | Possible Column Names |
|----------------|----------------------|
| user_id | user_id, id, userid, user id |
| name | name, full_name, fullname, first_name, last_name |
| gender_identity | gender_identity, gender, genderidentity |
| sex | sex, biological_sex, biologicalsex |
| residing_ph | residing_ph, residing_in_philippines, philippines_resident |
| gender_preference | gender_preference, grouping_preference, preference |
| country | country, nationality |
| province | province, state_province |
| city | city, municipality |
| state | state, region |
| go_solo | go_solo, solo, prefer_solo |

## Example Output

The script will:
1. Read the "Merged Data" sheet from your Excel file
2. Automatically map columns based on available column names
3. Group participants according to their preferences
4. Generate an Excel file with color-coded groups

## Testing

You can test the functionality using the provided test script:

```bash
python test_merged_grouping.py
```

This will:
1. Create a sample merged data file
2. Test the group assignment functionality
3. Show you the expected output format

## Troubleshooting

### Common Issues

1. **"Could not find column for X"**: The script couldn't find a matching column name. Check your data structure and column names.

2. **"Error reading Excel file"**: Make sure your Excel file has a "Merged Data" sheet.

3. **Missing data**: Some fields might be missing or have different names. The script will use default values.

### Debugging

The script provides detailed output showing:
- Column mapping found
- Number of participants processed
- Group creation process
- Final group statistics

## Data Requirements

Your merged data should contain at minimum:
- User identification (user_id)
- Name information
- Gender identity
- Grouping preferences
- Location information (country, province, city)
- Solo preference flag

## Output Format

The output Excel file contains:
- Group names with location and preference information
- Up to 5 members per group
- Color coding based on gender identity
- Solo groups for participants who prefer to work alone
- Additional metadata columns

## Integration with Streamlit App

This updated script integrates seamlessly with the Streamlit app workflow:

1. **Data Collection**: Use the Streamlit app to fetch data from APIs
2. **Data Merging**: Use the app's merge functionality
3. **Group Assignment**: Use this script for final group creation
4. **Results**: Get color-coded Excel files ready for distribution

## Customization

You can customize the grouping logic by modifying:
- `EXPECTED_COLUMNS`: Add new column name variations
- `SIMILAR_COUNTRIES`: Modify geographic grouping regions
- `GENDER_COLOR`: Change color coding for gender identities
- Group size limits in the merge functions 