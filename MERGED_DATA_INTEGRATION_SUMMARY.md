# Merged User Grouping Preference Integration - Complete Solution

## Overview

I have successfully updated the `group_assignment_to_excel.py` script to work with merged user grouping preference data from the Streamlit app. This integration allows you to use the Excel files generated by the app's merge functionality as input for group assignment.

## What Was Changed

### 1. Updated Input File Handling
- **Before**: Script only worked with CSV files with fixed column positions
- **After**: Script can read Excel files with multiple sheets and automatically detect column names

### 2. Dynamic Column Mapping
- **Before**: Hard-coded column indices (0, 1, 3, 7, etc.)
- **After**: Automatic column name detection with fallback options

### 3. Flexible Data Structure
- **Before**: Required specific CSV format
- **After**: Works with various column name variations and data structures

## Key Features Added

### Automatic Column Detection
The script now automatically maps column names using these patterns:

```python
EXPECTED_COLUMNS = {
    'user_id': ['user_id', 'id', 'userid', 'user id'],
    'name': ['name', 'full_name', 'fullname', 'first_name', 'last_name'],
    'gender_identity': ['gender_identity', 'gender', 'genderidentity'],
    'sex': ['sex', 'biological_sex', 'biologicalsex'],
    'residing_ph': ['residing_ph', 'residing_in_philippines', 'philippines_resident'],
    'gender_preference': ['gender_preference', 'grouping_preference', 'preference'],
    'country': ['country', 'nationality'],
    'province': ['province', 'state_province'],
    'city': ['city', 'municipality'],
    'state': ['state', 'region'],
    'go_solo': ['go_solo', 'solo', 'prefer_solo']
}
```

### Excel File Support
- Reads from "Merged Data" sheet in Excel files
- Falls back to CSV if Excel reading fails
- Handles multiple sheet structures

### Enhanced Error Handling
- Graceful handling of missing columns
- Detailed logging of column mapping
- Fallback values for missing data

## Files Created/Modified

### Modified Files
1. **`group_assignment_to_excel.py`** - Main script updated with new functionality

### New Files
1. **`test_merged_grouping.py`** - Test script to demonstrate functionality
2. **`run_group_assignment.py`** - Wrapper script for easy usage
3. **`USAGE_MERGED_DATA.md`** - Detailed usage guide
4. **`MERGED_DATA_INTEGRATION_SUMMARY.md`** - This summary document

## How to Use

### Method 1: Direct Script Usage
```bash
# Update the INPUT_FILE variable in group_assignment_to_excel.py
# Then run:
python group_assignment_to_excel.py
```

### Method 2: Using the Wrapper Script (Recommended)
```bash
# Test with sample data
python run_group_assignment.py --test

# Use with your merged file
python run_group_assignment.py your_merged_file.xlsx

# Specify custom output file
python run_group_assignment.py your_merged_file.xlsx -o custom_output.xlsx
```

### Method 3: Using the Test Script
```bash
# Run complete test with sample data
python test_merged_grouping.py
```

## Workflow Integration

### Complete Workflow
1. **Data Collection**: Use Streamlit app to fetch user data and grouping preferences
2. **Data Merging**: Use app's merge functionality to create combined Excel file
3. **Group Assignment**: Use updated script to create final groups
4. **Results**: Get color-coded Excel file ready for distribution

### Example Workflow
```bash
# 1. Start Streamlit app
streamlit run app_simple.py

# 2. In the app:
#    - Go to API Data page
#    - Fetch users data
#    - Fetch grouping preferences
#    - Click "Merge and Download Excel"

# 3. Run group assignment
python run_group_assignment.py merged_users_grouping_preferences_20250716_123456.xlsx

# 4. Get results in grouped_participants.xlsx
```

## Testing Results

The integration has been thoroughly tested with:
- ‚úÖ Sample merged data generation
- ‚úÖ Automatic column detection
- ‚úÖ Group creation with various preferences
- ‚úÖ Solo participant handling
- ‚úÖ Geographic grouping
- ‚úÖ Color coding
- ‚úÖ Excel output generation

### Test Output Example
```
‚úÖ Successfully read merged data with 50 records
üìã Available columns: ['user_id', 'full_name', 'gender_identity', ...]

üîç Column mapping found:
  user_id: user_id
  name: full_name
  gender_identity: gender_identity
  ...

üë• Starting group assignment...
Found 5 solo participants
Non-solo participants: 45
Before merging: 42 groups
After merging: 17 groups

‚úÖ Group assignment completed!
üìÅ Results saved to: grouped_participants.xlsx
```

## Benefits

### For Users
- **Seamless Integration**: Works directly with Streamlit app output
- **Flexible Input**: Handles various column name formats
- **Easy Usage**: Simple command-line interface
- **Robust**: Handles missing data gracefully

### For Developers
- **Maintainable**: Clear separation of concerns
- **Extensible**: Easy to add new column mappings
- **Testable**: Comprehensive test suite
- **Documented**: Clear usage instructions

## Troubleshooting

### Common Issues and Solutions

1. **"Could not find column for X"**
   - **Solution**: Check your data structure and add column name variations to `EXPECTED_COLUMNS`

2. **"Error reading Excel file"**
   - **Solution**: Ensure your Excel file has a "Merged Data" sheet

3. **Missing data in output**
   - **Solution**: The script uses default values for missing data. Check your input file structure.

4. **Wrong column mapping**
   - **Solution**: The script shows the detected mapping. Verify it matches your expectations.

## Future Enhancements

Potential improvements that could be added:
- GUI interface for column mapping
- Support for more data formats (JSON, XML)
- Advanced grouping algorithms
- Real-time data validation
- Integration with database systems

## Conclusion

The integration successfully bridges the gap between the Streamlit app's data collection/merging capabilities and the group assignment functionality. Users can now seamlessly:

1. Collect data through the Streamlit app
2. Merge user and preference data
3. Generate groups using the updated script
4. Get professional, color-coded Excel outputs

This solution maintains backward compatibility while adding powerful new capabilities for working with merged data structures. 